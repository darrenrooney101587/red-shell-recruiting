{% extends '_base.html' %}
{% load static %}
{% load filters %}
{% load tags %}
{% block title %}
    Candidate Search
{% endblock %}
{% block css-extra %}
    <link rel="stylesheet" href="{% static 'css/candidate.css' %}?n={% css_invalidate_int %}">
{% endblock %}
{% block content %}
    <div style="max-width:1000px; width: 50%; margin: 4rem auto 0;">
        <div id="candidate-view-mode" class="section">
            <div class="field-set flex-display" style="column-gap: 2rem">
                <div style="width: 50%; position: relative">
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">First Name</span>
                        <input type="text" value="{{ candidate.first_name }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Last Name</span>
                        <input type="text" value="{{ candidate.last_name }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">State</span>
                        <input type="text" value="{{ candidate.state }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">City</span>
                        <input type="text" value="{{ candidate.city }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Job Title</span>
                        <input type="text" value="{{ candidate.title.display_name }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                </div>
                <div style="width: 50%; position: relative">
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Phone Number</span>
                        <input type="tel" value="{{ candidate.phone_number }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Email</span>
                        <input type="email" value="{{ candidate.email }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Compensation</span>
                        <input type="text" value="{{ candidate.compensation }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div class="align-baseline column flex-display flex-start toggle-container" style="margin-top: 1rem;">
                        <div class="flex-display vertical-align space-between" style="width: 150px; margin-bottom: 1rem">
                            <h4 style="margin-right: 0.5rem; color: var(--theme-base-color); opacity: 0.7;">Actively Looking</h4>
                            {% include 'red_shell_recruiting/components/success_fail_component.html' with value=candidate.actively_looking %}
                        </div>
                        <div class="flex-display vertical-align space-between" style="width: 150px; margin-bottom: 1rem">
                            <h4 style="margin-right: 0.5rem; color: var(--theme-base-color); opacity: 0.7;">Open to Relocation</h4>
                            {% include 'red_shell_recruiting/components/success_fail_component.html' with value=candidate.open_to_relocation %}
                        </div>
                        <div class="flex-display vertical-align space-between" style="width: 150px; margin-bottom: 1rem">
                            <h4 style="margin-right: 0.5rem; color: var(--theme-base-color); opacity: 0.7;">Currently Working</h4>
                            {% include 'red_shell_recruiting/components/success_fail_component.html' with value=candidate.currently_working %}
                        </div>
                    </div>
                    <hr>
                    <div class="flex-display column" style="margin-bottom: 1rem;">
                        <h4 style="color: var(--theme-base-color); opacity: 0.7;">Placement History</h4>
                        {% if candidate.placement_record.all %}
                            <ul style="padding-left: 1rem; margin-top: 0.5rem;">
                                {% for record in candidate.placement_record.all %}
                                    <li style="margin-bottom: 0.25rem;">
                                        {{ record.placement.display_name }} â€” {{ record.month }}/{{ record.year }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p style="opacity: 0.6;">No placements recorded.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div style="margin-bottom: 1rem;">
                <span style="color: var(--faded-gray-color)" class="small-title">Notes</span>
                <textarea class="text-input" style="border: 1px solid var(--ui-support-element-color); height: 200px; padding: 0.5rem;" disabled>{{ candidate.notes }}</textarea>
            </div>
            <div class="flex-display flex-end" style="width: 100%;">
                <button class="button flex-display vertical-align space-between" id="edit-button">
                    {% include 'red_shell_recruiting/components/svg_components.html' with type='edit' %}
                    <span style="margin-left: 3px;">Edit Candidate</span>
                </button>
            </div>
            <hr>
            <span style="color: var(--faded-gray-color)" class="small-title">Resumes</span>
            <ul>
                {% for resume in candidate.resumes.all %}
                    {% if not resume.archived %}
                        <li style="margin-bottom: 0.5rem;">
                            <a href="{{ resume.get_signed_url }}" download>{{ resume.file.name|filename }}</a>
                            <span style="font-size: 9px; color: var(--accent-text-color)">
                                (Uploaded {{ resume.created_at|date:"Y-m-d H:i" }})
                            </span>
                            <form method="post" action="{% url 'archive-resume' resume.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button class="button" type="submit" style="margin-left: 0.5rem; padding: 0;">
                                    <div style="position: relative; top: 2px">
                                        {% include 'red_shell_recruiting/components/svg_components.html' with type='close' %}
                                    </div>
                                </button>
                            </form>
                        </li>
                    {% endif %}
                {% empty %}
                    <li>No resumes uploaded yet.</li>
                {% endfor %}
            </ul>
            <div class="flex-display vertical-align" style="margin-right:3rem; margin-top: 1rem;">
                <input required style="display: none;" type="file" id="candidate-resume" name="candidate_resume" accept=".pdf, .doc, .docx">
                <button id="trigger-resume-upload" class="button flex-display vertical-align space-between">
                    {% include 'red_shell_recruiting/components/svg_components.html' with type='quick-add' %}
                    <span style="margin-left: 3px;">Add Resume</span>
                </button>
                <div style="margin-left: 1rem;" id="file-name"></div>
                <button id="add-resume-button" class="button flex-display vertical-align space-between" style="display:none; margin-left: 1rem;">
                    {% include 'red_shell_recruiting/components/svg_components.html' with type='download' %}
                    <span style="margin-left: 3px;">Upload</span>
                </button>
            </div>
            <hr>
            <span style="color: var(--faded-gray-color)" class="small-title">Documents</span>
            <ul>
                {% for document in candidate.documents.all %}
                    {% if not document.archived %}
                        <li style="margin-bottom: 0.5rem;">
                            <a href="{{ resume.get_signed_url }}" download>{{ document.file.name|filename }}</a>
                            <span style="font-size: 9px; color: var(--accent-text-color)">
                                (Uploaded {{ document.created_at|date:"Y-m-d H:i" }})
                            </span>
                            <form method="post" action="{% url 'archive-document' document.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button class="button" type="submit" style="margin-left: 0.5rem; padding: 0;">
                                    <div style="position: relative; top: 2px">
                                        {% include 'red_shell_recruiting/components/svg_components.html' with type='close' %}
                                    </div>
                                </button>
                            </form>
                        </li>
                    {% endif %}
                {% empty %}
                    <li>No dcouments uploaded yet.</li>
                {% endfor %}
            </ul>
            <div class="flex-display vertical-align" style="margin-top: 1rem;">
                <input type="file" id="candidate-document" name="candidate_document" style="display: none;" accept=".pdf,.doc,.docx">

                <button type="button" id="trigger-document-upload" class="button flex-display vertical-align space-between">
                    {% include 'red_shell_recruiting/components/svg_components.html' with type='quick-add' %}
                    <span style="margin-left: 3px;">Add Document</span>
                </button>

                <div id="document-file-name" style="margin-left: 1rem;"></div>

                <button id="add-document-button" class="button flex-display vertical-align space-between" style="display: none; margin-left: 1rem;">
                    {% include 'red_shell_recruiting/components/svg_components.html' with type='download' %}
                    <span style="margin-left: 3px;">Upload</span>
                </button>
            </div>
        </div>
        <div id="candidate-edit-mode" class="section" style="display: none;">
            <form method="post">
                {% csrf_token %}
                <div class="field-set flex-display" style="column-gap: 2rem; min-height: 280px;">
                    <div style="width: 50%; position: relative">
                        <input type="text" name="first-name" class="text-input" placeholder="First Name" value="{{ candidate.first_name }}" style="border-bottom: 1px solid var(--ui-support-element-color)">
                        <input type="text" name="last-name" class="text-input" placeholder="Last Name" value="{{ candidate.last_name }}" style="border-bottom: 1px solid var(--ui-support-element-color)">
                        {% include 'red_shell_recruiting/components/state_dropdown_component.html' %}
                        {% include 'red_shell_recruiting/components/city_dropdown_component.html' %}
                        {% include 'red_shell_recruiting/components/title_dropdown_component.html' with selected_title=candidate.title %}
                    </div>
                    <div style="width: 50%; position: relative">
                        <input type="tel" name="phone-number" class="text-input" placeholder="Phone Number" value="{{ candidate.phone_number }}" style="border-bottom: 1px solid var(--ui-support-element-color)">
                        <input type="email" name="email" class="text-input" placeholder="Email" value="{{ candidate.email }}" style="border-bottom: 1px solid var(--ui-support-element-color)">
                        <input name="compensation" class="text-input" type="number" placeholder="Compensation" value="{{ candidate.compensation }}" style="border-bottom: 1px solid var(--ui-support-element-color)">
                        <div class="align-baseline column flex-display flex-start toggle-container" style="margin-top: 1rem; margin-bottom: 1rem;">
                            <label class="toggle flex-display vertical-align justify-center" style="margin-bottom: 1rem;">
                                <input name="actively-looking" id="candidate-looking" class="toggle-checkbox" type="checkbox" {% if candidate.actively_looking %}checked{% endif %}>
                                <div class="toggle-switch"></div>
                                <span>Actively Looking</span>
                            </label>
                            <label class="toggle flex-display vertical-align justify-center" style="margin-bottom: 1rem;">
                                <input name="open-to-relocation" id="candidate-relocation" class="toggle-checkbox" type="checkbox" {% if candidate.open_to_relocation %}checked{% endif %}>
                                <div class="toggle-switch"></div>
                                <span>Open to Relocation</span>
                            </label>
                            <label class="toggle flex-display vertical-align justify-center" style="margin-bottom: 1rem;">
                                <input name="currently-working" id="candidate-working" class="toggle-checkbox" type="checkbox" {% if candidate.currently_working %}checked{% endif %}>
                                <div class="toggle-switch"></div>
                                <span>Currently Working</span>
                            </label>
                            <label class="toggle flex-display vertical-align justify-center" style="margin-bottom: 1rem;">
                                <input name="client-placement" id="edit-client-placement-toggle" class="toggle-checkbox" type="checkbox"
                                       {% if candidate.placement_record.exists %}checked{% endif %}>
                                <div class="toggle-switch"></div>
                                <span>Previously Placed</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="client-placement-section">
                    <div id="placement-records-wrapper-edit" class="flex-display column" style="{% if not candidate.placement_record.exists %}display: none;{% endif %}">
                        {% for record in candidate.placement_record.all %}
                            <div class="placement-line-item flex-display align-center"
                                 data-index="{{ forloop.counter }}"
                                 data-placement-id="{{ record.id }}"
                                 style="margin-bottom: 1rem;">
                                {% with forloop.counter|stringformat:"s" as counter_str %}
                                    {% with "placement_id_"|add:counter_str as placement_input_name %}
                                        {% include 'red_shell_recruiting/components/candidate_placement_dropdown_component.html' with selected_placement=record.placement name=placement_input_name id_suffix=forloop.counter all_placements=all_placements %}
                                    {% endwith %}
                                {% endwith %}
                                <input name="placement_month_{{ forloop.counter }}" value="{{ record.month }}" placeholder="Month" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color); margin-left: 1rem; width: 80px;">
                                <input name="placement_year_{{ forloop.counter }}" value="{{ record.year }}" placeholder="Year" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color); margin-left: 1rem; width: 100px;">
                                <input type="hidden" name="placement_record_id_{{ forloop.counter }}" value="{{ record.id }}">
                                <input type="hidden" name="delete_placement_{{ forloop.counter }}" value="false" class="delete-marker">
                                <button type="button" class="button remove-placement" style="margin-left: 0.5rem;">
                                    {% include 'red_shell_recruiting/components/svg_components.html' with type='close' %}
                                </button>
                            </div>
                        {% endfor %}
                        <input type="hidden" name="placement_total_count" value="{{ candidate.placement_record.count }}">
                    </div>
                    <button type="button" class="button" id="add-placement-line-edit">+ Add Placement</button>
                </div>
                <hr>
                <textarea name="notes" class="text-input" placeholder="Notes" style="border: 1px solid var(--ui-support-element-color); height: 200px; padding: 0.5rem;">{{ candidate.notes }}</textarea>
                <hr>
                <div style="width: 100%" class="flex-display vertical-align justify-center space-between">
                    <button class="button flex-display vertical-align justify-center space-between" type="button" id="cancel-button">
                        {% include 'red_shell_recruiting/components/svg_components.html' with type='close-basic' %}
                        <span style="margin-left: 3px;">Cancel</span>
                    </button>
                    <button class="button flex-display vertical-align justify-center space-between" type="submit">
                        {% include 'red_shell_recruiting/components/svg_components.html' with type='edit' %}
                        <span style="margin-left: 3px;">Save Changes</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            // INPUT PAGE TOGGLE
            $('#client-placement').change(function () {
                const isChecked = $(this).is(':checked');
                if (isChecked) {
                    $('#placement-records-wrapper').slideDown(200);
                } else {
                    $('#placement-records-wrapper').slideUp(200);
                    $('#placement-records-wrapper').find('.placement-line-item').remove();
                    placementIndex = 0;
                }
            });

            // EDIT PAGE TOGGLE
            $('#edit-client-placement-toggle').change(function () {
                const isChecked = $(this).is(':checked');
                const $wrapper = $('#placement-records-wrapper-edit');

                if (isChecked) {
                    $wrapper.slideDown(200);
                    $wrapper.find('.placement-line-item').show();
                } else {
                    $wrapper.slideUp(200);
                    $wrapper.find('.placement-line-item').hide();
                }
            });

            // ADD PLACEMENT (EDIT MODE)
            let placementIndex = parseInt($('input[name="placement_total_count"]').val()) || 0;

            $('#add-placement-line-edit').click(function () {
                placementIndex++;

                $('#edit-client-placement-toggle').prop('checked', true).trigger('change');

                const newLine = `
        <div class="placement-line-item flex-display align-center" data-index="${placementIndex}" style="margin-bottom: 1rem;">
            <div class="custom-dropdown" style="border-bottom: 1px solid var(--ui-support-element-color);">
                <div class="flex-display space-between">
                    <div class="selected-option client-placement-dropdown">Select a Client</div>
                    <span class="chevron-down">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true">
                            <path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="m16 10-4 4-4-4"/>
                        </svg>
                    </span>
                    <span class="chevron-up" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true" style="transform: rotate(180deg);">
                            <path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="m16 10-4 4-4-4"/>
                        </svg>
                    </span>
                </div>
                <ul class="dropdown-list client-placement-list"></ul>
                <input class="client-placement-hidden" type="hidden" name="placement_id_${placementIndex}" value="">
            </div>
            <input name="placement_month_${placementIndex}" placeholder="Month" class="text-input" style="margin-left: 1rem; width: 80px; border-bottom: 1px solid var(--ui-support-element-color);">
            <input name="placement_year_${placementIndex}" placeholder="Year" class="text-input" style="margin-left: 1rem; width: 100px; border-bottom: 1px solid var(--ui-support-element-color);">
            <input type="hidden" name="delete_placement_${placementIndex}" value="false" class="delete-marker">
            <button type="button" class="button remove-placement" style="margin-left: 0.5rem;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2426 7.75736C16.6332 7.36683 16.6332 6.73367 16.2426 6.34314C15.8521 5.95262 15.2189 5.95262 14.8284 6.34314L12 9.17157L9.17157 6.34314C8.78105 5.95262 8.14788 5.95262 7.75736 6.34314C7.36683 6.73367 7.36683 7.36683 7.75736 7.75736L10.5858 10.5858L7.75736 13.4142C7.36683 13.8047 7.36683 14.4379 7.75736 14.8284C8.14788 15.2189 8.78105 15.2189 9.17157 14.8284L12 12L14.8284 14.8284C15.2189 15.2189 15.8521 15.2189 16.2426 14.8284C16.6332 14.4379 16.6332 13.8047 16.2426 13.4142L13.4142 10.5858L16.2426 7.75736Z" fill="currentColor"/>
                </svg>
            </button>
        </div>
    `;

                $('#placement-records-wrapper-edit').append(newLine);

                // Populate the dropdown list inside this new row
                const $newRow = $('#placement-records-wrapper-edit .placement-line-item').last();
                const $list = $newRow.find('.client-placement-list');

                $.get("{% url 'client-placement-list' %}", function (data) {
                    $list.empty();
                    data.forEach(function (item) {
                        $list.append(`<li class="option" data-value="${item.id}">${item.name}</li>`);
                    });
                });

                $('input[name="placement_total_count"]').val(placementIndex);
            });


            // REMOVE PLACEMENT LINE (Shared)
            $(document).on('click', '.remove-placement', function () {
                const group = $(this).closest('.placement-line-item');
                group.find('.delete-marker').val('true');
                group.hide();
            });

            // DELETE PLACEMENT TOGGLE (Edit Mode)
            $(document).on('click', '.delete-single-placement', function () {
                $('#client-placement-toggle-wrapper').slideUp(200);
                $('#client-placement-delete').val('true');
                $('#client-placement').prop('checked', false).trigger('change');
            });

            // DROPDOWN LOGIC
            {#$(document).on('click', '[id^="client-placement-dropdown-"]', function () {#}
            {#    const dropdown = $(this);#}
            {#    const idSuffix = dropdown.attr('id').replace('client-placement-dropdown-', '');#}
            {#    const list = $('#client-placement-list-' + idSuffix);#}
            {#    const hiddenInput = $('#client-placement-hidden-' + idSuffix);#}
            {##}
            {#    $('.dropdown-list').not(list).hide(); // Close all others#}
            {#    list.toggle();#}
            {##}
            {#    list.find('.option').off('click').on('click', function () {#}
            {#        const selectedText = $(this).text();#}
            {#        const selectedValue = $(this).data('value');#}
            {#        dropdown.text(selectedText);#}
            {#        hiddenInput.val(selectedValue);#}
            {#        list.hide();#}
            {#    });#}
            {#});#}


            $(document).on('click', function (e) {
                if (!$(e.target).closest('.custom-dropdown').length) {
                    $('.dropdown-list').hide();
                }
            });

            // RESUME UPLOAD
            $('#trigger-resume-upload').on('click', function () {
                $('#candidate-resume').click();
            });

            $('#candidate-resume').on('change', function () {
                const file = this.files[0];
                if (file) {
                    $('#file-name').text(file.name);
                    $('#add-resume-button').show();
                } else {
                    $('#file-name').text('');
                    $('#add-resume-button').hide();
                }
            });

            $('#add-resume-button').on('click', function () {
                const fileInput = $('#candidate-resume')[0];
                if (fileInput.files.length === 0) {
                    alert('Please select a file first.');
                    return;
                }

                const formData = new FormData();
                formData.append('resume', fileInput.files[0]);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                $.ajax({
                    url: '{% url "upload-resume" candidate.id %}',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function () {
                        location.reload();
                    },
                    error: function () {
                        alert('Failed to upload resume.');
                    }
                });
            });

            // DOCUMENT UPLOAD
            $('#trigger-document-upload').on('click', function () {
                $('#candidate-document').click();
            });

            $('#candidate-document').on('change', function () {
                const file = this.files[0];
                if (file) {
                    $('#document-file-name').text(file.name);
                    $('#add-document-button').show();
                } else {
                    $('#document-file-name').text('');
                    $('#add-document-button').hide();
                }
            });

            $('#add-document-button').on('click', function () {
                const fileInput = $('#candidate-document')[0];
                if (fileInput.files.length === 0) {
                    alert('Please select a document first.');
                    return;
                }

                const formData = new FormData();
                formData.append('candidate_document', fileInput.files[0]);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                $.ajax({
                    url: '{% url "upload-document" candidate.id %}',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function () {
                        location.reload();
                    },
                    error: function () {
                        alert('Failed to upload document.');
                    }
                });
            });

            // TOGGLE TO EDIT MODE
            $('#edit-button').on('click', function () {
                $('#candidate-view-mode').hide();
                $('#candidate-edit-mode').show();

                $('#state-hidden').val('{{ candidate.state }}');
                $('#city-hidden').val('{{ candidate.city }}');
                $('#state-dropdown').text('{{ candidate.state }}');
                $('#city-dropdown').text('{{ candidate.city }}');
                $('#city-dropdown-wrapper').show();
            });

            // CANCEL BUTTON
            $('#cancel-button').on('click', function () {
                $('#candidate-edit-mode').hide();
                $('#candidate-view-mode').show();
            });
        });
    </script>


{% endblock %}
