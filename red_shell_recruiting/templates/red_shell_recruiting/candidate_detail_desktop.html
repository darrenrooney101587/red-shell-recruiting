{% extends '_base.html' %}
{% load static %}
{% load filters %}
{% load tags %}
{% block title %}
    Edit Candidate
{% endblock %}
{% block css-extra %}
    <link rel="stylesheet" href="{% static 'css/candidate.css' %}?n={% css_invalidate_int %}">
    <link rel="stylesheet" href="{% static 'css/daterangepicker.css' %}">
{% endblock %}
{% block content %}
    <div class="section" style="width: 70%; margin: 2rem auto 0;">
        <div class="messages"></div>
        <div id="candidate-view-mode">
            <h3 class="medium-title">Demographic Info</h3>
            <hr>
            <div class="field-set flex-display" style="column-gap: 2rem; position:relative;">
                <div style="width: 33%; position: relative">
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">First Name</span>
                        <input type="text" value="{{ candidate.first_name }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Last Name</span>
                        <input type="text" value="{{ candidate.last_name }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">State</span>
                        <input type="text" value="{{ candidate.state }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">City</span>
                        <input type="text" value="{{ candidate.city }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Job Title</span>
                        <input type="text" value="{{ candidate.title.display_name }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    {% include 'red_shell_recruiting/components/candidate_linked_in_url.html' %}
                </div>
                <div style="width: 33%; position: relative">
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Phone Number</span>
                        <input type="tel" value="{{ candidate.phone_number }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Email</span>
                        <input type="email" value="{{ candidate.email }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Compensation range</span>
                        <div class="flex-display">
                            <input type="text" value="{{ candidate.compensation_from }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color); margin-right: 1rem;" disabled>
                            <input type="text" value="{{ candidate.compensation_to }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                        </div>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Ownership</span>
                        <input type="text" value="{{ candidate.ownership.display_name }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div>
                        <span style="color: var(--faded-gray-color)" class="small-title">Source</span>
                        <input type="text" value="{{ candidate.source.display_name }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)" disabled>
                    </div>
                    <div class="grid-cols-2 gap-2 toggle-container" style="margin-top: 1rem;">
                        <label class="toggle flex-display vertical-align align-start">
                            <input class="toggle-checkbox" type="checkbox" {% if candidate.actively_looking %}checked{% endif %} disabled>
                            <div class="toggle-switch"></div>
                            <span>Actively Looking</span>
                        </label>
                        <label class="toggle flex-display vertical-align align-start">
                            <input class="toggle-checkbox" type="checkbox" {% if candidate.open_to_relocation %}checked{% endif %} disabled>
                            <div class="toggle-switch"></div>
                            <span>Open to Relocation</span>
                        </label>
                        <label class="toggle flex-display vertical-align align-start">
                            <input class="toggle-checkbox" type="checkbox" {% if candidate.currently_working %}checked{% endif %} disabled>
                            <div class="toggle-switch"></div>
                            <span>Currently Working</span>
                        </label>
                    </div>
                </div>
                <div style="width: 33%; position: relative">
                    <div style="margin-bottom: 1rem;">
                        <span style="color: var(--faded-gray-color)" class="small-title">Initial Notes</span>
                        <textarea class="text-input" style="border: 1px solid var(--ui-support-element-color); height: 300px; padding: 0.5rem;" disabled>{{ candidate.entry_notes }}</textarea>
                    </div>
                </div>
            </div>
            <hr>
            <div class="flex-display flex-end" style="width: 100%;">
                {% include 'red_shell_recruiting/components/candidate_button.html' with type='button' color='green' text='Edit Candidate' extra_class='flex-display vertical-align space-between' id='edit-button' %}
            </div>
        </div>
        <div id="candidate-edit-mode" style="display: none;">
            <form method="post">
                {% csrf_token %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="alert {{ message.tags }} alert-dismissible fade show flex-display space-between vertical-align" role="alert" style="width: 100%;">
                            <span class="message-text">{{ message }}</span>
                            {% include 'red_shell_recruiting/components/candidate_close_button.html' %}
                        </div>
                    {% endfor %}
                </div>
                <br>
                <div class="field-set flex-display" style="column-gap: 2rem; position:relative;">
                    <div style="width: 33%; position: relative">
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">First Name</span>
                            <input type="text" id="candidate-first-name" name="candidate-first-name" class="text-input" placeholder="First Name" value="{{ candidate.first_name }}" style="border-bottom: 1px solid var(--ui-support-element-color)">
                        </div>
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">Last Name</span>
                            <input type="text" id="candidate-last-name" name="candidate-last-name" class="text-input" placeholder="Last Name" value="{{ candidate.last_name }}" style="border-bottom: 1px solid var(--ui-support-element-color)">
                        </div>
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">State</span>
                            {% include 'red_shell_recruiting/components/state_dropdown_component.html' %}
                        </div>
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">City</span>
                            {% include 'red_shell_recruiting/components/city_dropdown_component.html' %}
                        </div>
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">Job Title</span>
                            {% include 'red_shell_recruiting/components/title_dropdown_component.html' with selected_title=candidate.title %}
                        </div>
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">LinkedIn Profile URL</span>
                            <input type="text" name="candidate-linkedin-url" class="text-input" placeholder="Linkedin URL" value="{{ candidate.linkedin_url|default_if_none:"" }}" style="border-bottom: 1px solid var(--ui-support-element-color)">
                        </div>
                    </div>
                    <div style="width: 33%; position: relative">
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">Phone Number</span>
                            <input type="tel" id="candidate-phone-number" name="candidate-phone-number" class="text-input" placeholder="Phone Number" value="{{ candidate.phone_number }}" style="border-bottom: 1px solid var(--ui-support-element-color)">
                        </div>
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">Email</span>
                            <input type="email" id="candidate-email" name="candidate-email" class="text-input" placeholder="Email" value="{{ candidate.email }}" style="border-bottom: 1px solid var(--ui-support-element-color)">
                        </div>
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">Compensation range</span>
                            <div class="flex-display">
                                <input type="text" id="candidate-compensation-from" name="candidate-compensation-from" value="{{ candidate.compensation_from }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color); margin-right: 1rem;">
                                <input type="text" id="candidate-compensation-to" name="candidate-compensation-to" value="{{ candidate.compensation_to }}" class="text-input" style="border-bottom: 1px solid var(--ui-support-element-color)">
                            </div>
                        </div>
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">Ownership</span>
                            {% if user|in_groups:"Site Admin" or user.is_superuser or user|has_perm:required_permission %}
                                {% include 'red_shell_recruiting/components/ownership_dropdown_component.html' with selected_owner=candidate.ownership %}
                            {% else %}
                                {% include 'red_shell_recruiting/components/ownership_dropdown_component.html' with selected_owner=candidate.ownership disabled=True %}
                            {% endif %}
                        </div>
                        <div>
                            <span style="color: var(--faded-gray-color)" class="small-title">Source</span>
                            {% include 'red_shell_recruiting/components/source_dropdown_component.html' with selected_source=candidate.source %}
                        </div>
                        <div class="grid-cols-2 gap-2 toggle-container" style="margin-top: 1rem; margin-bottom: 1rem;">
                            <label class="toggle flex-display vertical-align align-start" style="margin-bottom: 1rem;">
                                <input name="candidate-actively-looking" id="candidate-looking" class="toggle-checkbox" type="checkbox" {% if candidate.actively_looking %}checked{% endif %}>
                                <div class="toggle-switch"></div>
                                <span>Actively Looking</span>
                            </label>
                            <label class="toggle flex-display vertical-align align-start" style="margin-bottom: 1rem;">
                                <input name="candidate-open-to-relocation" id="candidate-relocation" class="toggle-checkbox" type="checkbox" {% if candidate.open_to_relocation %}checked{% endif %}>
                                <div class="toggle-switch"></div>
                                <span>Open to Relocation</span>
                            </label>
                            <label class="toggle flex-display vertical-align align-start" style="margin-bottom: 1rem;">
                                <input name="candidate-currently-working" id="candidate-working" class="toggle-checkbox" type="checkbox" {% if candidate.currently_working %}checked{% endif %}>
                                <div class="toggle-switch"></div>
                                <span>Currently Working</span>
                            </label>
                        </div>
                    </div>
                    <div style="width: 33%; position: relative">
                        <div style="margin-bottom: 1rem;">
                            <span style="color: var(--faded-gray-color)" class="small-title">Initial Notes</span>
                            {% if user|in_groups:"Site Admin" or user.is_superuser or user|has_perm:required_permission %}
                                <textarea id="candidate-initial-notes" name="candidate-initial-notes" class="text-input" placeholder="Initial Notes" style="border: 1px solid var(--ui-support-element-color); height: 300px; padding: 0.5rem;">{{ candidate.entry_notes }}</textarea>
                            {% else %}
                                <textarea id="candidate-initial-notes" name="candidate-initial-notes" class="text-input" placeholder="Initial Notes" style="border: 1px solid var(--ui-support-element-color); height: 300px; padding: 0.5rem;" disabled>{{ candidate.entry_notes }}</textarea>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="flex-display flex-end" style="width: 100%; margin-top: 2rem;">
                    {% include 'red_shell_recruiting/components/candidate_button.html' with type='button' color='red' text='Cancel' extra_class='flex-display vertical-align justify-center space-between' style='margin-right: 1rem;' id='cancel-button' %}
                    {% include 'red_shell_recruiting/components/candidate_button.html' with type='submit' color='green' text='Save Changes' extra_class='flex-display vertical-align justify-center space-between' id='submit-btn' %}
                </div>
            </form>
        </div>
    </div>
    <div class="section" style="width: 70%; margin: 2rem auto 0;">
        <div class="flex-display vertical-align">
            <h3 class="medium-title">Journal Entries</h3>
        </div>
        <div class="journal-messages messages" style="margin-top: 1rem;"></div>
        <hr>
        <div style="flex: 1; border: 1px solid #eee; border-radius: 8px; padding: 1rem;">
            <div id="journal-entry-fields" class="flex-display vertical-align space-between" style="width: 100%;">
                <div style="width: 75%;">
                    <textarea id="journal-notes" style="border: 1px solid var(--ui-support-element-color); width: 100%; height: 75px; padding: 0.5rem;" name="notes" class="text-input" placeholder="Meeting notes..."></textarea>
                </div>
                <div class="flex-display column justify-center">
                    <div style="width: 150px;; margin-bottom: 1rem;">
                        {% include 'red_shell_recruiting/components/candidate_button.html' with type='button' text='Select date' id='journal-meeting-date' name='meeting_date' required=True style='width:100%;' %}
                    </div>
                    {% include 'red_shell_recruiting/components/candidate_button.html' with type='button' color='green' text='Add Journal Entry' extra_class='button green' style='width: 150px;' id='add-journal-entry-btn' %}
                </div>
            </div>
            <hr>
            <div id="journal-entries-list" style="margin-top: 1rem;"></div>
        </div>
    </div>
    <div class="section" style="width: 70%; margin: 2rem auto 0;">
        <div class="flex-display vertical-align">
            <h3 class="medium-title">Placement Records</h3>
        </div>
        <div class="placement-messages messages" style="margin-top: 1rem;"></div>
        <hr>
        <div style="flex: 1; border: 1px solid #eee; border-radius: 8px; padding: 1rem;">
            <div id="placement-entry-fields" class="flex-display vertical-align space-between" style="width: 100%;">
                <div class="flex-display vertical-align" style="width: 100%; height: 75px; gap: 1rem;">
                    <div style="width: 300px;">
                        <h3 style="color: var(--faded-gray-color)" class="small-title">Client</h3>
                        {% include 'red_shell_recruiting/components/candidate_placement_dropdown_component.html' with selected_placement=None name='placement-client' id_suffix='placement-records' all_placements=all_placements %}
                    </div>
                    <div style="width: 200px;">
                        <h3 style="color: var(--faded-gray-color)" class="small-title">Month</h3>
                        {% include 'red_shell_recruiting/components/month_dropdown_component.html' with selected_month=None name='placement-month' %}
                    </div>
                    <div style="width: 200px;">
                        <h3 style="color: var(--faded-gray-color)" class="small-title">Year</h3>
                        {% with year_range=1990|get_range:2027 %}
                            {% include 'red_shell_recruiting/components/year_dropdown_component.html' with selected_year=None name='placement-year' year_range=year_range %}
                        {% endwith %}
                    </div>
                    <div style="width: 250px;">
                        <h3 style="color: var(--faded-gray-color)" class="small-title">Compensation</h3>
                        <input type="number" id="placement-compensation" class="text-input" placeholder="Compensation" style="width: 100%; border-bottom: 1px solid var(--ui-support-element-color);">
                    </div>
                </div>
                {% include 'red_shell_recruiting/components/candidate_button.html' with type='button' color='green' text='Add Placement' extra_class='button green' style='width: 150px;' id='add-placement-record-btn' %}
            </div>
            <div id="placement-records-list" style="margin-top: 1rem;"></div>
        </div>
    </div>
    <div class="section flex-display space-between" style="width: 70%; margin: 2rem auto 0;">
        <div class="section-group flex-display space-between" style="width: 100%">
            <div class="section-col">
                <h3 class="medium-title">Resumes</h3>
                <hr>
                <ul class="section-list">
                    {% for resume in resumes %}
                        <li class="section-list-item{% if not forloop.first %} section-list-item-border{% endif %}">
                            <a href="{{ resume.get_signed_url }}" download>{{ resume.file.name|filename }}</a>
                            <form method="post" action="{% url 'archive-resume' resume.id %}" style="display: inline;">
                                {% csrf_token %}
                                {% include 'red_shell_recruiting/components/candidate_button.html' with type='submit' color='red' text='Remove' extra_class='button' style='margin-left: 0.5rem;' %}
                            </form>
                        </li>
                    {% empty %}
                        <li class="small-title" style="opacity: 0.6">No resumes uploaded yet.</li>
                    {% endfor %}
                </ul>
                <hr>
                <div class="section-actions">
                    <input required type="file" id="candidate-resume" name="candidate_resume" accept=".pdf, .doc, .docx">
                    {% with button_type='button' button_text='Attach Resume' button_extra_class='align-start' button_id='trigger-resume-upload' %}
                        {% include 'red_shell_recruiting/components/candidate_button.html' with type=button_type text=button_text extra_class=button_extra_class id=button_id %}
                    {% endwith %}
                    <div class="file-name ellipsis" id="file-name"></div>
                    {% with button_type='button' button_color='green' button_text='Upload' button_extra_class='button green flex-display vertical-align space-between' button_style='display:none; margin-left: 1rem;' button_id='add-resume-button' %}
                        {% include 'red_shell_recruiting/components/candidate_button.html' with type=button_type color=button_color text=button_text extra_class=button_extra_class style=button_style id=button_id %}
                    {% endwith %}
                </div>
            </div>
            <div class="section-col">
                <h3 class="medium-title">Culinary Portfolios</h3>
                <hr>
                <ul class="section-list">
                    {% for portfolio in portfolios %}
                        <li class="section-list-item{% if not forloop.first %} section-list-item-border{% endif %}">
                            <a href="{{ portfolio.get_signed_url }}" download>{{ portfolio.file.name|filename }}</a>
                            <form method="post" action="{% url 'archive-culinary-portfolio' portfolio.id %}" style="display: inline;">
                                {% csrf_token %}
                                {% include 'red_shell_recruiting/components/candidate_button.html' with type='submit' color='red' text='Remove' extra_class='button' style='margin-left: 0.5rem;' %}
                            </form>
                        </li>
                    {% empty %}
                        <li class="small-title" style="opacity: 0.6">No portfolios uploaded yet.</li>
                    {% endfor %}
                </ul>
                <hr>
                <div class="section-actions">
                    <input type="file" id="candidate-culinary-portfolio" name="candidate_culinary_portfolio" accept=".pdf, .doc, .docx">
                    {% with button_type='button' button_text='Attach Portfolio' button_extra_class='align-start' button_id='trigger-portfolio-upload' %}
                        {% include 'red_shell_recruiting/components/candidate_button.html' with type=button_type text=button_text extra_class=button_extra_class id=button_id %}
                    {% endwith %}
                    <div class="file-name ellipsis" id="portfolio-file-name"></div>
                    {% with button_type='button' button_color='green' button_text='Upload' button_extra_class='align-end' button_style='display:none; margin-left: 1rem;' button_id='add-portfolio-button' %}
                        {% include 'red_shell_recruiting/components/candidate_button.html' with type=button_type color=button_color text=button_text extra_class=button_extra_class style=button_style id=button_id %}
                    {% endwith %}
                </div>
            </div>
            <div class="section-col">
                <h3 class="medium-title">Documents</h3>
                <hr>
                <ul class="section-list">
                    {% for document in documents %}
                        <li class="section-list-item{% if not forloop.first %} section-list-item-border{% endif %}">
                            <a href="{{ document.get_signed_url }}" download>{{ document.file.name|filename }}</a>
                            <form method="post" action="{% url 'archive-document' document.id %}" style="display: inline;">
                                {% csrf_token %}
                                {% include 'red_shell_recruiting/components/candidate_button.html' with type='submit' color='red' text='Remove' extra_class='button' style='margin-left: 0.5rem;' %}
                            </form>
                        </li>
                    {% empty %}
                        <li class="small-title" style="opacity: 0.6">No document uploaded yet.</li>
                    {% endfor %}
                </ul>
                <hr>
                <div class="section-actions">
                    <input type="file" id="candidate-document" name="candidate_document" accept=".pdf, .doc, .docx">
                    {% with button_type='button' button_text='Attach Document' button_extra_class='align-start' button_id='trigger-document-upload' %}
                        {% include 'red_shell_recruiting/components/candidate_button.html' with type=button_type text=button_text extra_class=button_extra_class id=button_id %}
                    {% endwith %}
                    <div class="file-name ellipsis" id="document-file-name"></div>
                    {% with button_type='button' button_color='green' button_text='Upload' button_extra_class='align-end' button_style='display: none; margin-left: 1rem;' button_id='add-document-button' %}
                        {% include 'red_shell_recruiting/components/candidate_button.html' with type=button_type color=button_color text=button_text extra_class=button_extra_class style=button_style id=button_id %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
    <script src="{% static 'js/candidate_edit_save.js' %}" crossorigin="anonymous"></script>
    <script src="{% static 'js/moment.min.js' %}"></script>
    <script src="{% static 'js/daterangepicker.js' %}"></script>
    <script>

        const clientPlacementListUrl = "{% url 'client-placement-list' %}";
        const uploadCulinaryPortfolioUrl = "{% url 'upload-culinary-portfolio' candidate.id %}";
        const uploadResumeUrl = "{% url "upload-resume" candidate.id %}";
        const uploadDocumentUrl = '{% url "upload-document" candidate.id %}';
        const journalEntryUrl = '{% url "journal-entries" candidate.id %}';
        const placementRecordsUrl = '{% url "placement-records" candidate.id %}';

        $(document).ready(function () {

            // TOGGLE TO EDIT MODE
            $('#edit-button').on('click', function () {
                $('#candidate-view-mode').hide();
                $('#candidate-edit-mode').show();
                $('#state-hidden').val('{{ candidate.state }}');
                $('#city-hidden').val('{{ candidate.city }}');
                $('#state-dropdown').text('{{ candidate.state }}');
                $('#city-dropdown').text('{{ candidate.city }}');
                $('#city-dropdown-wrapper').show();
            });

            LoadPlacementRecords();
            LoadPlacementClients();
            HandleNewPlacementRecord();
            HandleRemovePlacementRecord();
        });
    </script>
{% endblock %}
