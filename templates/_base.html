{% extends 'base.html' %}
{% load static %}
{% load tags %}
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="{% static 'css/bootstrap.min.css'%}" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="{% static 'css/bootstrap-icons.css'%}" crossorigin="anonymous">
        <link rel="stylesheet" href="{% static 'css/common.css'%}?n={% css_invalidate_int %}" crossorigin="anonymous">
        <link rel="icon" href="{% static 'favicon.ico' %}">
        {% block css-extra %}
        {% endblock %}
        <title>
            {% block title %}
            {% endblock %}
        </title>
        <script src="{% static 'js/jquery-3.3.1.js' %}" crossorigin="anonymous"></script>
    </head>
    {% block body %}
        <body class="main-body">
            {% if not request.is_mobile %}
                <header class="page-header bg-light d-flex align-items-center justify-content-between px-3"
                        style="height: 60px; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 4px 0 rgba(0, 0, 0, .04);">
                    <a class="a-suppressed" href="{% url 'home' %}">
                        <div class="d-flex align-items-center">
                            <span class="h5 mb-0">Red Shell Recruiting</span>
                        </div>
                    </a>
                    <div>
                        <a href="{% url 'privacy-policy' %}" class="btn btn-link" style="font-size: 0.9rem;">Privacy Policy</a>
                        <a href="{% url 'terms-of-service' %}" class="btn btn-link" style="font-size: 0.9rem;">Terms of Service</a>
                    </div>
                </header>
            {% endif %}
            {% if request.user.is_authenticated %}
                {% if request.is_mobile %}
                    {% include 'sidebar_mobile_component.html' %}
                {% else %}
                    {% include 'sidebar_desktop_component.html' %}
                {% endif %}
            {% endif %}
            <main style="flex: 1" class="content-container col-md-12 ml-sm-auto col-lg-12 pt-3" >
                {% block content %}
                {% endblock %}
            </main>
            <footer class="footer">
                <div class="footer-row">
                    <div class="footer__separator">Â© 2025 Red Shell Recruiting. All rights reserved.</div>
                    <div class="footer__separator">Owned and operated by Red Shell Recruiting.</div>
                </div>
                <div class="footer-row">
                    <div class="footer__separator">
                        <a href="{% url 'privacy-policy' %}">Privacy Policy</a>
                    </div>
                    <div>
                        <a href="{% url 'terms-of-service' %}">Terms of Service</a>
                    </div>
                </div>
            </footer>
        </body>
    {% endblock %}
    {% block script %}
    <script>

        function PlacementActions() {
            // INPUT PAGE TOGGLE
            $('#client-placement').change(function () {
                const isChecked = $(this).is(':checked');
                if (isChecked) {
                    $('#placement-records-wrapper').slideDown(200);
                } else {
                    $('#placement-records-wrapper').slideUp(200);
                    $('#placement-records-wrapper').find('.placement-line-item').remove();
                    placementIndex = 0;
                }
            });

            // EDIT PAGE TOGGLE
            $('#edit-client-placement-toggle').change(function () {
                const isChecked = $(this).is(':checked');
                const $wrapper = $('#placement-records-wrapper-edit');

                if (isChecked) {
                    $wrapper.slideDown(200);
                    $wrapper.find('.placement-line-item').show();
                    $('#remove-all-placements-flag').val('false');
                    $('#remove-placement-warning').hide();
                } else {
                    $wrapper.slideUp(200);
                    $wrapper.find('.placement-line-item').hide();
                    $('#remove-all-placements-flag').val('true');
                    $('#remove-placement-warning').fadeIn(200);
                }
            });

            // ADD PLACEMENT (EDIT MODE)
            let placementIndex = parseInt($('input[name="placement_total_count"]').val()) || 0;

            $('#add-placement-line-edit').click(function () {
                placementIndex++;

                $('#edit-client-placement-toggle').prop('checked', true).trigger('change');

                const newLine = `
                    <div class="placement-line-item flex-display align-center" data-index="${placementIndex}" style="margin-bottom: 1rem;">
                        <div class="custom-dropdown" style="border-bottom: 1px solid var(--ui-support-element-color);">
                            <div class="flex-display space-between">
                                <div class="selected-option client-placement-dropdown">Select a Client</div>
                                <span class="chevron-down">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true">
                                        <path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="m16 10-4 4-4-4"/>
                                    </svg>
                                </span>
                                <span class="chevron-up" style="display: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" aria-hidden="true" style="transform: rotate(180deg);">
                                        <path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="m16 10-4 4-4-4"/>
                                    </svg>
                                </span>
                            </div>
                            <ul class="dropdown-list client-placement-list"></ul>
                            <input class="client-placement-hidden" type="hidden" name="placement_id_${placementIndex}" value="">
                        </div>
                        <input name="placement_month_${placementIndex}" placeholder="Month" class="text-input" style="margin-left: 1rem; width: 80px; border-bottom: 1px solid var(--ui-support-element-color);">
                        <input name="placement_year_${placementIndex}" placeholder="Year" class="text-input" style="margin-left: 1rem; width: 100px; border-bottom: 1px solid var(--ui-support-element-color);">
                        <input type="hidden" name="delete_placement_${placementIndex}" value="false" class="delete-marker">
                        <button type="button" class="button remove-placement" style="margin-left: 0.5rem;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M16.2426 7.75736C16.6332 7.36683 16.6332 6.73367 16.2426 6.34314C15.8521 5.95262 15.2189 5.95262 14.8284 6.34314L12 9.17157L9.17157 6.34314C8.78105 5.95262 8.14788 5.95262 7.75736 6.34314C7.36683 6.73367 7.36683 7.36683 7.75736 7.75736L10.5858 10.5858L7.75736 13.4142C7.36683 13.8047 7.36683 14.4379 7.75736 14.8284C8.14788 15.2189 8.78105 15.2189 9.17157 14.8284L12 12L14.8284 14.8284C15.2189 15.2189 15.8521 15.2189 16.2426 14.8284C16.6332 14.4379 16.6332 13.8047 16.2426 13.4142L13.4142 10.5858L16.2426 7.75736Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                `;

                $('#placement-records-wrapper-edit').append(newLine);

                // Populate the dropdown list inside this new row
                const $newRow = $('#placement-records-wrapper-edit .placement-line-item').last();
                const $list = $newRow.find('.client-placement-list');

                $.get("{% url 'client-placement-list' %}", function (data) {
                    $list.empty();
                    data.forEach(function (item) {
                        $list.append(`<li class="option" data-value="${item.id}">${item.name}</li>`);
                    });
                });

                $('input[name="placement_total_count"]').val(placementIndex);

                // REMOVE PLACEMENT LINE (Shared)
                $(document).on('click', '.remove-placement', function () {
                    const group = $(this).closest('.placement-line-item');
                    group.find('.delete-marker').val('true');
                    group.hide();
                });

                // DELETE PLACEMENT TOGGLE (Edit Mode)
                $(document).on('click', '.delete-single-placement', function () {
                    $('#client-placement-toggle-wrapper').slideUp(200);
                    $('#client-placement-delete').val('true');
                    $('#client-placement').prop('checked', false).trigger('change');
                });

                $(document).on('click', function (e) {
                    if (!$(e.target).closest('.custom-dropdown').length) {
                        $('.dropdown-list').hide();
                    }
                });

            });
        }

        function SubmitCandidate() {
            $('#submit-btn').click(function (event) {

                const state = $('#state-hidden').val();
                const city = $('#city-hidden').val();

                if (!state || !city) {
                    event.preventDefault();
                    console.log('Submitting...');
                    addClientMessage('Please select both a State and a City.');
                    return false;
                }

                const phone = $('#candidate-phone-number').val().trim();
                const email = $('#candidate-email').val().trim();

                const phoneDigits = phone.replace(/\D/g, '');
                if (phoneDigits.length < 10 || phoneDigits.length > 15) {
                    event.preventDefault();
                    addClientMessage('Please enter a valid phone number.');
                    return false;
                }

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    event.preventDefault();
                    addClientMessage('Please enter a valid email address.');
                    return false;
                }

                const resume = $('#resume').val();

                if (!resume) {
                    event.preventDefault();
                    $('#file-name').css('color', 'red').text('Please upload a resume before submitting.');
                    return false;
                }

            });

            $('#resume').change(function() {
                const fileName = $(this).val().split('\\').pop();
                if (fileName) {
                    $('#file-name').css('color', 'black').text(fileName);
                }
            });

            $(document).on('click', '.custom-close', function() {
                $(this).closest('.alert').fadeOut('slow');
            });
        }

        function populateCandidateTitles() {
            const list = $('#candidate-title-list');
            list.empty();

            $.get("{% url 'candidate-title-list' %}", function(data) {
                data.forEach(function(item) {
                    list.append(`<li class="option" data-value="${item.id}">${item.name}</li>`);
                });
            }).fail(function() {
                addClientMessage('Error fetching titles.');
            });
        }

        $(document).ready(function () {

            populateClientPlacements();
            populateCandidateTitles();

            // title click handler
            $('#candidate-title-list').on('click', '.option', function (event) {
                event.stopPropagation();
                const titleId = $(this).data('value');
                const titleText = $(this).text();

                $('#candidate-title-dropdown').text(titleText);
                $('#candidate-title-hidden').val(titleId);

                $(this).closest('.dropdown-list').hide();
                $(this).closest('.custom-dropdown').find('.chevron-down').show();
                $(this).closest('.custom-dropdown').find('.chevron-up').hide();
            });

            // placement click handler
            $(document).on('click', '.client-placement-list .option', function (event) {
                event.stopPropagation();

                const $option = $(this);
                const clientId = $option.data('value');
                const clientName = $option.text();

                const $dropdown = $option.closest('.custom-dropdown');
                const $display = $dropdown.find('.client-placement-dropdown');
                const $hidden = $dropdown.find('.client-placement-hidden');

                $display.text(clientName);
                $hidden.val(clientId);

                $dropdown.find('.dropdown-list').hide();
                $dropdown.find('.chevron-down').show();
                $dropdown.find('.chevron-up').hide();
            });

            // general dropdown show/hide
            $(document).on('click', '.custom-dropdown', function (event) {
                const dropdownList = $(this).find('.dropdown-list');
                const chevronDown = $(this).find('.chevron-down');
                const chevronUp = $(this).find('.chevron-up');

                event.stopPropagation();

                if (dropdownList.is(':visible')) {
                    dropdownList.hide();
                    chevronDown.show();
                    chevronUp.hide();
                } else {
                    dropdownList.show();
                    chevronDown.hide();
                    chevronUp.show();
                }
            });

            // toggle input page show placement elements
            $('#client-placement').change(function () {
                const isChecked = $(this).is(':checked');
                if (isChecked) {
                    $('#client-placement-toggle-wrapper').slideDown(200);
                } else {
                    $('#client-placement-toggle-wrapper').slideUp(200);
                    $('#client-placement-dropdown').text('Select a Client Placement');
                    $('#client-placement-hidden').val('');
                }
            });

            $('#candidate-phone-number').on('input', function() {
                let input = $(this).val();
                input = input.replace(/\D/g, '');

                if (input.length > 3 && input.length <= 6) {
                    input = input.slice(0,3) + '-' + input.slice(3);
                } else if (input.length > 6) {
                    input = input.slice(0,3) + '-' + input.slice(3,6) + '-' + input.slice(6,10);
                }

                $(this).val(input);
            });

            $(document).click(function(event) {
                if (!$(event.target).closest('.custom-dropdown').length) {
                    $('.dropdown-list').hide();
                    $('.chevron-down').show();
                    $('.chevron-up').hide();
                }
            });

            $(".nav-dropdown-container").hover(
                function () {
                    $(this).find(".nav-dropdown-submenu").stop(true, true).slideDown(200);
                    $(this).find(".chevron-down").hide();
                    $(this).find(".chevron-up").show();
                },
                function () {
                    $(this).find(".nav-dropdown-submenu").stop(true, true).slideUp(200);
                    $(this).find(".chevron-up").hide();
                    $(this).find(".chevron-down").show();
                }
            );

            $(".accordion-section .accordion").click(function() {
                $(this).toggleClass("active");
                let panel = $(this).next()
                panel.toggleClass("active");
                let caret = $(this).find('.accordion-block i');
                if(caret.hasClass("fa-angle-down")) {
                    caret.removeClass('fa-angle-down').addClass('fa-angle-up')
                } else {
                    caret.removeClass('fa-angle-up').addClass('fa-angle-down')
                }
            });

            $('#state-list').on('click', '.option', function(event) {
                event.stopPropagation();
                const state = $(this).data('value');
                const stateName = $(this).data('fullname');

                $('#state-dropdown').text(stateName);
                $('#state-hidden').val(state);

                $(this).closest('.dropdown-list').hide();
                $(this).closest('.custom-dropdown').find('.chevron-down').show();
                $(this).closest('.custom-dropdown').find('.chevron-up').hide();

                populateCities(state);
            });

            $('#city-list').on('click', '.option', function(event) {
                event.stopPropagation();
                const city = $(this).data('value');
                const cityName = $(this).text();

                $('#city-dropdown').text(cityName);
                $('#city-hidden').val(city);

                $(this).closest('.dropdown-list').hide();
                $(this).closest('.custom-dropdown').find('.chevron-down').show();
                $(this).closest('.custom-dropdown').find('.chevron-up').hide();
            });

            $('#hamburger-button').click(function() {
                $('#mobile-menu').addClass('active');
            });

            $('#close-mobile-menu').click(function() {
                $('#mobile-menu').removeClass('active');
            });

        });

        function populateCities(state) {
            $('.spinner-wrapper').show();
            $('.simple-spinner').show();

            $('#city-list').empty();
            const apiKey = 'darren101587';
            const geocodeUrl = `https://secure.geonames.org/searchJSON?formatted=true&lang=en&country=US&adminCode1=${state}&maxRows=500&username=${apiKey}`;

            $.get(geocodeUrl, function(data) {
                const cities = data.geonames.sort(function(a, b) {
                    return a.name.localeCompare(b.name);
                });

                cities.forEach(function(city) {
                    $('#city-list').append(`<li class="option" data-value="${city.name}">${city.name}</li>`);
                });

                $('.spinner-wrapper').hide();
                $('#city-list').show();
                $('#city-dropdown-wrapper').show();
            }).fail(function() {
                addClientMessage('Error fetching cities.');
                $('.spinner-wrapper').hide();
            });
        }

        function populateClientPlacements() {
            $.get("{% url 'client-placement-list' %}", function(data) {
                $('.client-placement-list').each(function() {
                    const list = $(this);
                    list.empty();

                    data.forEach(function(item) {
                        list.append(`<li class="option" data-value="${item.id}">${item.name}</li>`);
                    });
                });

                $('.custom-dropdown').show();
            }).fail(function() {
                addClientMessage('Error fetching clients.');
            });
        }


        function addClientMessage(messageText, messageType = 'error') {
            const alertClass = messageType === 'success' ? 'alert-success' : 'alert-danger';
            const messageHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: relative;">
                    ${messageText}
                    <span class="custom-close" style="position: absolute; top: 13px; right: 10px; cursor: pointer;">&times;</span>
                </div>
            `;
            $('.messages').append(messageHtml);
        }

    </script>
    {% endblock %}
</html>
